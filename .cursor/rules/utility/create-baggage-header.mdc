---
description:
globs:
alwaysApply: false
---
# Rule Name: create-baggage-header.mdc
# Description: How to create and use a baggage header for user-context requests to Pegasus services, following Fiverr Contexto platform best practices.


## How to Create and Use a Baggage Header


### 1. Create the Baggage Header
To generate a baggage header for a specific user, send a POST request to the pandas-pegasus contexto_helper endpoint:


```bash
curl -X POST -H "Content-Type: application/json" \
 -d '{"userRequestContext": {"userId": <USER_ID>}}' \
 http://kube-lb.fiverrdev.com/pandas-pegasus/api/v1/contexto_helper/baggage
```
- Replace `<USER_ID>` with the desired user's ID.


**Best Practice:**
- Always use the official Contexto helper endpoint for generating baggage headers, as this ensures the correct trace context and user scoping for downstream services (@Contexto Support Docs).


### 2. Extract the Baggage Value
- The response will include a field like:
 ```
 "baggage":"request_context=CiIKIGYxNzE5ZDExZmRmMjdhODk5NTA1M2EzM2ExNjNiNDg2EgcaBQjcy70n"
 ```
- Use the entire value after `"baggage":` as the value for the `baggage` header in subsequent requests.


**Best Practice:**
- Ensure the baggage value is passed exactly as received, without modification, to maintain traceability and context propagation.


### 3. Use the Baggage Header in Requests
- For any request that requires user context (e.g., creating a conversation), include the header:
 ```
 baggage: request_context=CiIKIGYxNzE5ZDExZmRmMjdhODk5NTA1M2EzM2ExNjNiNDg2EgcaBQjcy70n
 ```
- Example usage in a POST request:
 ```bash
 curl -X POST -H "Content-Type: application/json" \
   -H "baggage: request_context=CiIKIGYxNzE5ZDExZmRmMjdhODk5NTA1M2EzM2ExNjNiNDg2EgcaBQjcy70n" \
   -d '{"modelId": "<MODEL_ID>"}' \
   http://localhost:3240/api/v1/playground/conversations
 ```


**Best Practice:**
- The `baggage` header is essential for distributed tracing and user context propagation across microservices.
- Do not include sensitive information in the baggage value; use only what is provided by the contexto helper.


## When to Use
- Any time a request to a Pegasus or related Fiverr service requires user context via a baggage header.
- Especially important for requests that cross service boundaries and require traceability or user scoping.


## Notes
- Always generate a fresh baggage header for each user session or when switching users.
- Do not include the userId in the request body unless explicitly required by the endpoint.
- If you encounter issues with context propagation or user scoping,

